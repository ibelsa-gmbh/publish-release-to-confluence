name: Release Notes to Confluence Publisher
author: Gershon Alvais
description: Confluence Release BOT. This action will create a release page in confluence with the release notes.
branding:
  icon: "book"
  color: "blue"

inputs:
  # Confluence configs
  spaceId:
    description: Confluence space id. This is the space where the release page will be created.
    required: true
    type: string
  status:
    required: true
    type: string
  title:
    description: Title of the page.  Release tag.
    required: true
    type: string
  parentId:
    description: Parent page id. The release page will be created under this page.
    required: true
    type: string
  ConfluenceBaseUrl:
    description: Confluence base url
    required: true
    type: string
  ConfluenceSpaceKey:
    description: Confluence space key
    type: string
  # Release notes
  tag:
    required: true
    type: string
  confluence_email:
    description: 'Confluence Email'
    required: true
    type: string
  confluence_api_token:
    description: 'Confluence API Token'
    required: true
    type: string
  appName:
    Description: Name of the app. This will be used in the release notes.
    required: true
    type: string
  repoOwner:
    Description: Owner of the repository. This will be used to fetch the release notes.
    required: true
    type: string
  repoName:
    Description: Name of the repository. This will be used to fetch the release notes.
    required: true
    type: string

runs:
  using: "composite"
  steps:
    - name: Get Release and PR Details
      id: get-release
      uses: actions/github-script@v7
      with:
        script: |
          const tag = '${{ inputs.tag }}';
          const owner = '${{ inputs.repoOwner }}';
          const repo = '${{ inputs.repoName }}';

          const release = await github.rest.repos.getReleaseByTag({ owner, repo, tag });
          let lines = release.data.body.split('\n');
          let newBody = "";

          for (let line of lines) {
            newBody += line + "\n";

            const prMatch = line.match(/\/pull\/([0-9]+)/);
            if (prMatch) {
              const prNumber = prMatch[1];
              try {
                const pr = await github.rest.pulls.get({ owner, repo, pull_number: parseInt(prNumber) });
                let prBody = pr.data.body || ""
                //Remove PR Scheme
                prBody = prBody.replace(/#PRSCHEMA_START#[\s\S]*?#PRSCHEMA_END#/g, "");
                //Remove HTML
                prBody = prBody.replace(new RegExp("", "g"), "");

                const descMatch = prBody.match(/###\s+(?:Beschreibung|Description)\s*([\s\S]*?)(?=\n###|$)/i);

                if (descMatch && descMatch[1].trim()) {
                  const cleanDesc = descMatch[1].trim()
                    .replace(/\r?\n/g, ' ')
                    .replace(/["'{}]/g, '')
                    .trim();

                  newBody += "\n{status:color=Grey|title=INFO|subtle=true}\n" + cleanDesc + "\n{status}\n\n";
                }
              } catch (e) {
                console.log(`Konnte Details fÃ¼r PR #${prNumber} nicht laden.`);
              }
            }
          }

          return {
              body: newBody,
              url: `https://github.com/${owner}/${repo}/releases/tag/${tag}`
          };

    - name: Post Release Notes to Confluence
      id: post_to_confluence
      shell: bash
      env:
        RELEASE_DATA: ${{ steps.get-release.outputs.result }}
      run: |
        RELEASE_NOTES=$(echo "$RELEASE_DATA" | jq -r '.body')
        RELEASE_URL=$(echo "$RELEASE_DATA" | jq -r '.url')
        # 1. Generate German Locale Date
        sudo locale-gen de_DE.UTF-8
        GERMAN_DATE_WITH_TIME=$(LANG=de_DE.UTF-8 date +"%d.%m.%Y %H:%M")
        GERMAN_DATE_WITH_DAY_AND_TIME=$(LANG=de_DE.UTF-8 date +"%A, %d. %B %Y %H:%M")

        # 2. Build Release notes
        HEADER="âœ… Neuer *${{ inputs.appName }}* Release deployed!\nðŸ“† ${GERMAN_DATE_WITH_DAY_AND_TIME}\nLink zum Release (GitHub): [${{ inputs.tag }}](${RELEASE_URL})"
        RELEASE_NOTES="${HEADER}\n\n${RELEASE_NOTES}"

        # 3. Format
        RELEASE_NOTES=$(echo -e "${RELEASE_NOTES}" | sed -r 's/^#+ ?//g')

        # Remove '##' from RELEASE_NOTES
        RELEASE_NOTES=$(echo "${RELEASE_NOTES}" | sed 's/## //g')

        # Remove extra HTML
        RELEASE_NOTES=$(echo "${RELEASE_NOTES}" | sed -r 's/<[^>]*>//g')

        # Replace markdown links with confluence links
        RELEASE_NOTES=$(echo "${RELEASE_NOTES}" | sed -r 's/\[([^]]+)\]\(([^)]+)\)/[\1|\2]/g')

        # Replace @username with a link to the user's GitHub profile
        RELEASE_NOTES=$(echo "${RELEASE_NOTES}" | sed -r 's/@([^ ]+)/[@\1|https:\/\/github.com\/\1]/g')

        # Replace '\n' with '<br/>'
        RELEASE_NOTES=$(echo "${RELEASE_NOTES}" | sed 's/\\n/<br\/>/g')

        # Prepare the payload
        payload=$(jq -n \
          --arg spaceId "${{ inputs.spaceId }}" \
          --arg status "${{ inputs.status }}" \
          --arg title "${GERMAN_DATE_WITH_TIME} ${{ inputs.tag }}" \
          --arg parentId "${{ inputs.parentId }}" \
          --arg value "$RELEASE_NOTES" \
          '{
              "spaceId": $spaceId,
              "status": $status,
              "title": $title,
              "parentId": $parentId,
              "body": {
                "representation": "wiki",
                "value": $value
              }
          }')

        echo "Payload: $payload"
        response=$(curl --request POST \
            --url '${{ inputs.ConfluenceBaseUrl }}/wiki/api/v2/pages' \
            --user '${{ inputs.confluence_email }}:${{ inputs.confluence_api_token }}' \
            --header 'Accept: application/json' \
            --header 'Content-Type: application/json' \
            --data "$payload")
        echo "Response: $response"
        pageId=$(echo "$response" | jq -r '.id')
        if [ "$pageId" == "null" ] || [ -z "$pageId" ]; then
          echo "âŒ Failed to create page. Response: $response"
          exit 1
        fi

        echo "âœ… Page created with ID: $pageId"
        echo "pageId=$pageId" >> "$GITHUB_ENV"
